@page "/"
@using StoneHammer.Components
@using StoneHammer.Systems
@implements IDisposable
@inject AssetManager AssetManager
@inject CityBridge CityBridge
@inject IJSRuntime JSRuntime
@inject CombatService CombatService

<PageTitle>StoneHammer</PageTitle>

<div class="game-ui">
    <div class="row mt-2">
        <div class="col">
            <button class="btn btn-primary" @onclick="SpawnAsPlayer">Spawn as Master Mason</button>
            <button class="btn btn-info" @onclick="SpawnBartender">Spawn Bartender</button>
            <button class="btn btn-warning" @onclick="SpawnStore">Spawn General Store</button>
            <button class="btn btn-success" @onclick="GenerateTown">Generate High-Fidelity Town</button>
            <button class="btn btn-secondary" @onclick="SpawnSandboxPillar">Spawn Sandbox Pillar</button>
            <button class="btn btn-info" @onclick="SpawnGuildMaster">Spawn Guild Master</button>
            <button class="btn btn-danger" @onclick="ClearScene">Clear Scene</button>
        </div>
    </div>
</div>

<SceneView />
<CombatView />

@code {
    private DotNetObjectReference<Home>? _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("stoneHammer.setDotNetHelper", _objRef);
        }
    }

    [JSInvokable]
    public async Task HandleEnterBuilding(string buildingName) => await AssetManager.EnterBuilding(buildingName);

    [JSInvokable]
    public async Task HandleExitBuilding(float x, float z) => await AssetManager.ExitBuilding(x, z);
    
    [JSInvokable]
    public async Task StartCombat(string mobName)
    {
        await CombatService.StartCombat(mobName);
        StateHasChanged();
    }

    [JSInvokable]
    public void ClaimLoot(int amount)
    {
        CombatService.LogLoot(amount);
        StateHasChanged();
    }

    private async Task SpawnAsPlayer() => await AssetManager.SpawnPlayer();
    private async Task SpawnBartender() => await AssetManager.SpawnBartender(5, 5);
    private async Task SpawnStore() => await AssetManager.SpawnStore(0, 0);
    private async Task GenerateTown() => await AssetManager.GenerateTown();
    private async Task SpawnGuildMaster() => await AssetManager.SpawnGuildMaster(0, 5);
    private async Task ClearScene() => await AssetManager.ClearAll();
    private async Task SpawnSandboxPillar() => await JSRuntime.InvokeVoidAsync("stoneHammer.spawnSandboxPillar");

    public void Dispose() => _objRef?.Dispose();
}

<style>
    .game-btn {
        background: rgba(0, 0, 0, 0.7);
        color: #00f2ff;
        border: 1px solid #00f2ff;
        padding: 8px 16px;
        margin-right: 8px;
        cursor: pointer;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.2s;
    }

    .game-btn:hover {
        background: #00f2ff;
        color: #000;
    }
</style>
