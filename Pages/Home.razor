@page "/"
@using StoneHammer.Components
@using StoneHammer.Systems
@implements IDisposable
@inject AssetManager AssetManager
@inject CityBridge CityBridge
@inject IJSRuntime JSRuntime
@inject CombatService CombatService

@inject SaveService SaveService

<PageTitle>StoneHammer</PageTitle>

@if (!_gameStarted)
{
    <div class="start-screen">
        <div class="title-container">
            <h1 class="main-title">STONEHAMMER</h1>
            <p class="subtitle">Forged in Code. Bound by Iron.</p>
            <button class="btn-enter" @onclick="EnterGame">ENTER STORMHAMMER</button>
        </div>
    </div>
}

<div class="game-ui" style="@(_gameStarted ? "" : "display:none")">
    <div class="row mt-2">
        <div class="col">
            <button class="btn btn-primary" @onclick="SpawnAsPlayer">Spawn as Master Mason</button>
            <button class="btn btn-secondary" @onclick="ToggleCharacter">👤 Character</button>
            <button class="btn btn-info" @onclick="SpawnBartender">Spawn Bartender</button>
            <button class="btn btn-warning" @onclick="SpawnStore">Spawn General Store</button>
            <button class="btn btn-success" @onclick="GenerateTown">Generate High-Fidelity Town</button>
            <button class="btn btn-secondary" @onclick="SpawnSandboxPillar">Spawn Sandbox Pillar</button>
            <button class="btn btn-secondary" @onclick="SpawnSandboxPillar">Spawn Sandbox Pillar</button>
            <button class="btn btn-info" @onclick="SpawnGuildMaster">Spawn Guild Master</button>
            <button class="btn btn-dark" style="border:1px solid gold; color:gold" @onclick="OpenInn">🍺 Visit Inn</button>
            <button class="btn btn-danger" @onclick="ClearScene">Clear Scene</button>
        </div>
    </div>
</div>

<SceneView />
<CombatView />
<LootDialog />
<CharacterSheet @ref="_charSheet" />
<InnDialog @ref="_innDialog" />

@code {
    private DotNetObjectReference<Home>? _objRef;
    private bool _gameStarted = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("stoneHammer.setDotNetHelper", _objRef);
        }
    }
    
    private async Task EnterGame()
    {
        _gameStarted = true;
        StateHasChanged();
        
        await GenerateTown();

        // Auto-Load logic
        var latestSave = await SaveService.GetLatestSave();
        if (!string.IsNullOrEmpty(latestSave))
        {
            Console.WriteLine($"Auto-Loading Latest Save: {latestSave}");
            await SaveService.LoadGame(latestSave);
        }
    }

    [JSInvokable]
    public async Task HandleEnterBuilding(string buildingName) => await AssetManager.EnterBuilding(buildingName);

    [JSInvokable]
    public async Task HandleExitBuilding(float x, float z) => await AssetManager.ExitBuilding(x, z);
    
    [JSInvokable]
    public async Task StartCombat(string mobName)
    {
        await CombatService.StartCombat(mobName);
        StateHasChanged();
    }

    [JSInvokable]
    public void OpenLoot()
    {
        CombatService.OpenLootChest();
        StateHasChanged();
    }

    private async Task SpawnAsPlayer() => await AssetManager.SpawnPlayer();
    private async Task SpawnBartender() => await AssetManager.SpawnBartender(5, 5);
    private async Task SpawnStore() => await AssetManager.SpawnStore(0, 0);
    private async Task GenerateTown() => await AssetManager.GenerateTown();
    private async Task SpawnGuildMaster() => await AssetManager.SpawnGuildMaster(0, 5);
    private async Task ClearScene() => await AssetManager.ClearAll();
    private async Task SpawnSandboxPillar() => await JSRuntime.InvokeVoidAsync("stoneHammer.spawnSandboxPillar");

    private CharacterSheet? _charSheet;
    private void ToggleCharacter() => _charSheet?.Toggle();

    private InnDialog? _innDialog;
    private void OpenInn() => _innDialog?.Open();

    public void Dispose() => _objRef?.Dispose();
}

<style>
    .start-screen {
        position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
        background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
        display: flex; justify-content: center; align-items: center;
        z-index: 5000;
        animation: fadeIn 2s;
    }
    
    .title-container { text-align: center; color: white; }
    
    .main-title {
        font-family: 'Impact', sans-serif;
        font-size: 5rem;
        letter-spacing: 10px;
        background: -webkit-linear-gradient(#f9d423, #ff4e50);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 20px rgba(255, 78, 80, 0.5);
        margin-bottom: 0.5rem;
    }
    
    .subtitle {
        color: #888; letter-spacing: 4px; font-size: 1.2rem; margin-bottom: 3rem; text-transform: uppercase;
    }
    
    .btn-enter {
        background: transparent;
        border: 2px solid #ff4e50;
        color: #ff4e50;
        padding: 15px 40px;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 2px;
    }
    
    .btn-enter:hover {
        background: #ff4e50;
        color: white;
        box-shadow: 0 0 30px rgba(255, 78, 80, 0.6);
        transform: scale(1.05);
    }

    .game-ui {
        /* existing styles */
    }
    
    .game-btn {
        background: rgba(0, 0, 0, 0.7);
        color: #00f2ff;
        border: 1px solid #00f2ff;
        padding: 8px 16px;
        margin-right: 8px;
        cursor: pointer;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.2s;
    }

    .game-btn:hover {
        background: #00f2ff;
        color: #000;
    }
    
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
